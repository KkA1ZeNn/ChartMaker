<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <title>Document</title>
   <style>
      .settingBar {
         width: 100%;
         height: 7vh;
         display: flex;
         align-items: center;
         justify-content: flex-start;
         margin-bottom: 10px;
      }

      #options {
         width: auto;
         height: 25px;
         margin-left: 20px;
         display: flex;
         align-items: center;
         justify-content: flex-start;
      }

      #method {
         width: 130px;
      }

      #generationCount {
         width: 50px;
      }

      #generate {
         margin-left: 20px;
      }

      label {
         margin: 0px 10px 0px 20px;
      }

      #workspace {
         width: 100%;
         height: 90vh;
         display: flex;
         align-items: center;
         justify-content: flex-start;
      }

      #generatedValues {
         width: 6%;
         height: 100%;
         border: 2px solid black;
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: space-between;
         margin-right: 20px;
      }

      #description {
         width: 100%;
         height: 12%;
         border-bottom: 2px solid black;
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: space-between;
      }

      #description h4 {
         width: 100%;
         display: flex;
         align-items: center;
         justify-content: center;
         height: 50%;
         margin: 0;
         border-bottom: 2px solid black;
         box-sizing: border-box;
      }

      #KX {
         height: 50%;
         width: 100%;
         display: flex;
         align-items: center;
         justify-content: space-around;
      }

      #KX h5 {
         margin: 0;
         width: 50%;
         height: 100%;
         display: flex;
         align-items: center;
         justify-content: center;
      }

      #KX h5:first-child {
         border-right: 2px solid black;
      }

      #values {
         width: 100%;
         height: 88%;
         overflow-y: auto;
      }

      .valueRow {
         height: 7%;
         width: 100%;
         display: flex;
         align-items: center;
         justify-content: space-around;
         border-bottom: 2px solid gray;
         box-sizing: border-box;
      }

      .valueRow h5 {
         margin: 0;
         width: 50%;
         height: 100%;
         display: flex;
         align-items: center;
         justify-content: center;
      }

      .valueRow h5:first-child {
         border-right: 2px solid gray;
      }

      #graphics {
         width: 80%;
         height: 100%;
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: space-between;
      }

      .graphicsRow {
         width: 100%;
         height: 50%;
         display: flex;
         align-items: center;
         justify-content: space-between;
      }

      .graph {
         width: 50%;
         height: 100%;
      }

      #chartdiv {
         border: 2px solid black;
      }

      #values::-webkit-scrollbar {
         display: none;
      }

      .option {
         display: none;
         margin-right: 10px;
      }

   </style>
</head>
<body>
   <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
   <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
   <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
   <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
   <script src="https://cdn.amcharts.com/lib/5/locales/de_DE.js"></script>
   <script src="https://cdn.amcharts.com/lib/5/geodata/germanyLow.js"></script>
   <script src="https://cdn.amcharts.com/lib/5/fonts/notosans-sc.js"></script>


   <div class="settingBar">
      <input name="method" list="methods" id = "method" placeholder="Метод генерации">
      <datalist id="methods">
         <option value="1.1 Бернулли"></option>
         <option value="1.2 Биномиальное"></option>
         <option value="1.3 Пуассона"></option>
      </datalist>
      <button id = "clear">Clear</button>
      <label for="generationCount">Кол-во генер.знач.</label>
      <input name="count of generations" id = "generationCount" value = "100">

      <div id = "options">
         <input name = "option1" class = "option" id = "q" placeholder = "Вероятность успеха Q =" type = "text">
         <input name = "option2" class = "option" id = "m" placeholder = "Число исходов M =" type = "text">
         <input name = "option3" class = "option" id = "alpha" placeholder = "Интенсивность λ =" type = "text">
      </div>
      <button id = "generate">Генерация</button>
   </div>

   </div>
   <div id = "workspace">
      <div id = "generatedValues">
         <div id = "description">
            <h4>Выборка</h4>
            <div id = "KX">
               <h5>K</h5>
               <h5>X</h5>
            </div>
         </div>
         <div id = "values"></div>
      </div>
      <div id = "graphics">
         <div class = "graphicsRow">
            <div class = "graph" id = "graph1"></div>
            <div class = "graph" id = "graph2"></div>
         </div>
         <div class = "graphicsRow">
            <div class = "graph" id = "graph3"></div>
            <div class = "graph" id = "graph4"></div>
         </div>
      </div>
   </div>

   <script>
      const generationMethodHadler = document.querySelector('#method');
      const generationMethod = document.querySelector('#method');
      const generateButton = document.querySelector('#generate');
      const clearButton = document.querySelector('#clear');
      const generationCount = document.querySelector('#generationCount');
      const generatorOptionQ = document.querySelector('#q');
      const generatorOptionM = document.querySelector('#m');
      const generatorOptionAlpha = document.querySelector('#alpha');
      const valuesBar = document.querySelector('#values');
      let errorFlag = true;
      let values = [];

      clearButton.addEventListener('click', clear);

      function clear() {
         generatorOptionQ.style.display = "none";
         generatorOptionM.style.display = "none";
         generatorOptionAlpha.style.display = "none";
         generationMethod.value = "";
         errorFlag = true;
         if (root) {
            root.dispose();
            root2.dispose();
            root3.dispose();
            root4.dispose();
         }
      }

      generationMethodHadler.addEventListener('change', () => {
         switch (generationMethod.value) {
            case "1.1 Бернулли":
               generatorOptionQ.style.display = "block";
               errorFlag = false;
               break;

            case "1.2 Биномиальное":
               generatorOptionQ.style.display = "block";
               generatorOptionM.style.display = "block";
               errorFlag = false;
               break;

            case "1.3 Пуассона":
               generatorOptionAlpha.style.display = "block";
               errorFlag = false;
               break;
         
            default:
               clear();
               throw new Error ("Такого метода нет");
               break;
         }
      })

      generateButton.addEventListener('click', () => {
         if (!errorFlag) {
            valuesBar.innerHTML = ``;
            values = [];
            let newValue;
            for (let i = 0; i < generationCount.value; i++) {
               switch (generationMethod.value) {
                  case "1.1 Бернулли":
                     newValue = bernoulli( parseFloat(generatorOptionQ.value) );
                     break;

                  case "1.2 Биномиальное":
                     newValue = binomial( parseFloat( generatorOptionM.value), parseFloat( generatorOptionQ.value), 0 );
                     break;

                  case "1.3 Пуассона":
                     newValue = poisson( parseFloat( generatorOptionAlpha.value) );
                     break;
               }
         
               const valueRow = document.createElement('div');
               valueRow.classList.add("valueRow");
               valueRow.innerHTML = `
                  <h5>${ i + 1 }</h5>
                  <h5>${ newValue }</h5>
               `;
               valuesBar.appendChild(valueRow);
               values.push ( newValue );
            }

            temp = countOccurrences(values);
            graph1Creator();
            graph2Creator();
            graph3Creator();
            graph4Creator();
         }
      })

      // Функция, которая возвращает случайное целое число от min до max включительно
      function randomInt(min, max) {
         return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      // Функция, которая возвращает биномиально распределенное случайное число
      // n - количество испытаний, p - вероятность успеха
      function binomial(n, p) {
         let k = 0;
         // Повторяем n раз
         for (let i = 0; i < n; i++) {
            // Генерируем случайное число от 0 до 1
            let r = Math.random();
            // Если число меньше или равно p, то считаем это успехом и увеличиваем счетчик
            if (r <= p) {
               k++;
            }
         }
         // Возвращаем счетчик успехов
         return k;
      }

      // Функция, которая возвращает факториал числа n
      function factorial(n) {
         // Если n равно 0 или 1, то возвращаем 1
         if (n === 0 || n === 1) {
            return 1;
         }
         // Иначе, возвращаем произведение n и факториала n-1
         else {
            return n * factorial(n - 1);
         }
      }

      // Функция, которая возвращает биномиальный коэффициент
      // n - количество испытаний, k - количество успехов
      function binomialCoefficient(n, k) {
         // Возвращаем отношение факториалов n, k и n-k
         return factorial(n) / (factorial(k) * factorial(n - k));
      }

      // Функция, которая возвращает биномиальную вероятность
      // n - количество испытаний, p - вероятность успеха, k - количество успехов
      function binomialProbability(n, p, k) {
         // Возвращаем произведение биномиального коэффициента и степеней p и 1-p
         return binomialCoefficient(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
      }

      function bernoulli (q) {
         // Проверяем, что q - это число от 0 до 1
         if (typeof q !== "number" || q < 0 || q > 1) {
            throw new Error ("Q должно быть числом от 0 до 1");
         }
         // Генерируем случайное число от 0 до 1
         let random = Math.random ();
         // Сравниваем его с q и возвращаем результат
         return random <= q ? 1 : 0;
      }

      // Функция, которая возвращает пуассоновски распределенное случайное число
      // lambda - интенсивность события
      function poisson(lambda) {
         // Инициализируем k и u
         let k = 0;
         let u = Math.random();
         // Инициализируем F(k) и F(k-1)
         let F = Math.exp(-lambda); // F(0)
         let F_prev = 0; // F(-1)
         // Пока не найдем подходящее k
         while (u > F) {
            // Увеличиваем k на 1
            k++;
            // Обновляем F(k-1) и F(k)
            F_prev = F;
            F = F + Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
         }
         // Возвращаем k
         return k;
      }
      
      // Функция, которая возвращает биномиальную вероятность
      // k - количество событий, lambda - интенсивность события, n - количество испытаний
      function binomialProbability(k, lambda) {
         // Возвращаем произведение степени lambda n, факториала k и экспоненты отрицательного lambda n
         return Math.pow(lambda, k) / factorial(k) * Math.exp(-lambda);
      }
      //-------------------------------------------------------------------------
      let root; 
      let root2;
      let root3;
      let root4;
      let temp;
  
      function graph1Creator() {
         // Define data
         let data = [];
         let yAxis;
         let xAxis;
         let chart;

         if (root) {
            root.dispose();
         }
         root = am5.Root.new("graph1");
         root.setThemes([
            am5themes_Animated.new(root)
         ]);

         chart = root.container.children.push( 
            am5xy.XYChart.new(root, {
               panY: false,
               wheelY: "zoomX",
            }) 
         );

         for (let i = 0; i < values.length; ++i) {
            data.push({
               K: i + 1,
               X: values[i]
            });
         }

         // Create Y-axis
         yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
               strictMinMax: true,
               maxPrecision: 0,
               renderer: am5xy.AxisRendererY.new(root, {})
            })
         );

         // Create X-Axis
         xAxis = chart.xAxes.push(
            am5xy.ValueAxis.new(root, {
               min: 1,
               max: parseInt(generationCount.value),
               renderer: am5xy.AxisRendererX.new(root, {})
            })
         );

         var series = chart.series.push( 
            am5xy.LineSeries.new(root, { 
               name: "Series",
               xAxis: xAxis, 
               yAxis: yAxis, 
               valueYField: "X", 
               valueXField: "K",
               maskBullets: false
            }) 
         );
      
         series.bullets.push(function() {
            return am5.Bullet.new(root, {
               sprite: am5.Circle.new(root, {
                  radius: 5,
                  fill: series.get("fill")
               })
            });
         });
      
         series.strokes.template.set("strokeWidth", 2);
         series.data.setAll(data);
      }
   
      function graph2Creator() {
         // Define data
         let data = [];
         let yAxis;
         let xAxis;
         let chart;

         if (root2) {
            root2.dispose();
         }
         root2 = am5.Root.new("graph2");
         root2.setThemes([
            am5themes_Animated.new(root2)
         ]);

         chart = root2.container.children.push( 
            am5xy.XYChart.new(root2, {
               panY: false,
               wheelY: "zoomX",
               layout: root.verticalLayout
            }) 
         );

         for (key in temp) {
            data.push({
               "number": parseInt(key),
               "value": temp[key]
            });
         }

         // Create Y-axis
         yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root2, {
               strictMinMax: true,
               renderer: am5xy.AxisRendererY.new(root2, {})
            })
         );

         // Create X-Axis
         //xAxis = chart.xAxes.push(
         //   am5xy.ValueAxis.new(root2, {
         //      min: 0,
         //      max: maxValue2 >= 1 ? maxValue2 : 1,
         //      extraMax: 0.3,
         //      extraMin: 0.3,
         //      maxPrecision: 0,
         //      renderer: am5xy.AxisRendererX.new(root2, {})
         //   })
         //);

         xAxis = chart.xAxes.push(
            am5xy.CategoryAxis.new(root2, {
               categoryField: "number",
               renderer: am5xy.AxisRendererX.new(root2, {})
            })
         );

         xAxis.data.setAll(data);

         var series = chart.series.push( 
            am5xy.ColumnSeries.new(root2, { 
               name: "Series",
               xAxis: xAxis, 
               yAxis: yAxis, 
               valueYField: "value", 
               categoryXField: "number",
               tooltip: am5.Tooltip.new(root2, {
                  labelText: "'{categoryX}' = {valueY}"
               })
            }) 
         );

         series.columns.template.setAll({
            width: am5.percent(20)
         });
         
         chart.set("cursor", am5xy.XYCursor.new(root2, {}));

         let cursor = chart.get("cursor");
         cursor.lineY.setAll({
            visible: false
         });
         cursor.lineX.setAll({
            visible: false
         });

         series.data.setAll(data);
      }

      function graph3Creator() {
         // Define data
         let data = [];
         let yAxis;
         let xAxis;
         let chart;
         let teorValue;
         let otnValue;

         if (root3) {
            root3.dispose();
         }
         root3 = am5.Root.new("graph3");
         root3.setThemes([
            am5themes_Animated.new(root3)
         ]);

         chart = root3.container.children.push( 
            am5xy.XYChart.new(root3, {
               panY: false,
               wheelY: "zoomX",
               layout: root.verticalLayout
            }) 
         );

         switch (generationMethod.value) {
            case "1.1 Бернулли":
               for (key in temp) {
                  otnValue = temp[key] / parseInt(generationCount.value);
                  if (parseInt(key) == 1) {
                     teorValue = parseFloat(generatorOptionQ.value);
                  } else {
                     teorValue = 1 - parseFloat(generatorOptionQ.value);
                  }
                  data.push({
                     "number": parseInt(key),
                     "otnValue": otnValue,
                     "teorValue": teorValue
                  });
               }
               break;

            case "1.2 Биномиальное":
               for (key in temp) {
                  otnValue = temp[key] / parseInt(generationCount.value);
                  teorValue = binomialProbability( parseFloat( generatorOptionM.value), parseFloat( generatorOptionQ.value), parseInt(key) );
                  data.push({
                     "number": parseInt(key),
                     "otnValue": otnValue,
                     "teorValue": teorValue
                  });
               }
               break;

            case "1.3 Пуассона":
               for (key in temp) {
                  otnValue = temp[key] / parseInt(generationCount.value);
                  teorValue = binomialProbability( parseInt(key), parseFloat(generatorOptionAlpha.value) );
                  data.push({
                     "number": parseInt(key),
                     "otnValue": otnValue,
                     "teorValue": teorValue
                  });
               }
               break;
            }

         // Create Y-axis
         yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root3, {
               strictMinMax: true,
               renderer: am5xy.AxisRendererY.new(root3, {})
            })
         );

         // Create X-Axis
         //xAxis = chart.xAxes.push(
         //   am5xy.ValueAxis.new(root2, {
         //      min: 0,
         //      max: maxValue2 >= 1 ? maxValue2 : 1,
         //      extraMax: 0.3,
         //      extraMin: 0.3,
         //      maxPrecision: 0,
         //      renderer: am5xy.AxisRendererX.new(root2, {})
         //   })
         //);

         xAxis = chart.xAxes.push(
            am5xy.CategoryAxis.new(root3, {
               categoryField: "number",
               renderer: am5xy.AxisRendererX.new(root3, {})
            })
         );

         xAxis.data.setAll(data);

         var series = chart.series.push( 
            am5xy.ColumnSeries.new(root3, { 
               name: "Series",
               xAxis: xAxis, 
               yAxis: yAxis, 
               valueYField: "otnValue", 
               categoryXField: "number",
               tooltip: am5.Tooltip.new(root3, {
                  labelText: "отн.для {categoryX}={valueY}"
               })
            }) 
         );

         var series2 = chart.series.push( 
            am5xy.ColumnSeries.new(root3, { 
               name: "Series",
               xAxis: xAxis, 
               yAxis: yAxis, 
               valueYField: "teorValue", 
               categoryXField: "number",
               tooltip: am5.Tooltip.new(root3, {
                  labelText: "теор.для {categoryX}={valueY}"
               })
            }) 
         );

         series.columns.template.setAll({
            width: am5.percent(20)
         });
         series2.columns.template.setAll({
            width: am5.percent(20)
         });
         
         chart.set("cursor", am5xy.XYCursor.new(root3, {}));

         let cursor = chart.get("cursor");
         cursor.lineY.setAll({
            visible: false
         });
         cursor.lineX.setAll({
            visible: false
         });

         series.data.setAll(data);
         series2.data.setAll(data);

         console.log(data);
      }

      function graph4Creator() {
         // Define data
         let data = [];
         let yAxis;
         let xAxis;
         let chart;
         let otnValue;
         let lastValue = 0;

         if (root4) {
            root4.dispose();
         }
         root4 = am5.Root.new("graph4");
         root4.setThemes([
            am5themes_Animated.new(root4)
         ]);

         chart = root4.container.children.push( 
            am5xy.XYChart.new(root4, {
               panY: false,
               wheelY: "zoomX",
            }) 
         );

         for (key in temp) {
            otnValue = temp[key] / parseInt(generationCount.value) + lastValue;
            lastValue = otnValue;
            data.push({
               "number": parseInt(key),
               "Fx": otnValue
            });
         }

         // Create Y-axis
         yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root4, {
               strictMinMax: true,
               extraMax: 0.1,
               renderer: am5xy.AxisRendererY.new(root4, {})
            })
         );

         // Create X-Axis
         xAxis = chart.xAxes.push(
            am5xy.ValueAxis.new(root4, {
               strictMinMax: true,
               maxPrecision: 0,
               renderer: am5xy.AxisRendererX.new(root4, {})
            })
         );

         var series = chart.series.push( 
            am5xy.SmoothedXLineSeries.new(root4, { 
               name: "Series",
               xAxis: xAxis, 
               yAxis: yAxis, 
               valueYField: "Fx", 
               valueXField: "number",
               maskBullets: false,
               tooltip: am5.Tooltip.new(root4, {
                  labelText: "{valueY}"
               })
            }) 
         );
      
         series.bullets.push(function() {
            return am5.Bullet.new(root4, {
               sprite: am5.Circle.new(root4, {
                  radius: 5,
                  fill: series.get("fill")
               })
            });
         });
         
         series.get("tooltip").label.set("text", "{valueY}")
         chart.set("cursor", am5xy.XYCursor.new(root4, {
            behavior: "zoomXY",
            xAxis: xAxis
         }));
         yAxis.set("tooltip", am5.Tooltip.new(root4, {
            themeTags: ["axis"]
         }));

         series.strokes.template.set("strokeWidth", 2);
         series.data.setAll(data);
      }

      function countOccurrences(arr) {
         return arr.reduce((acc, curr) => {
            acc[curr] ? acc[curr]++ : (acc[curr] = 1);
            return acc;
         }, {});
      }
   </script>
</body>
</html>